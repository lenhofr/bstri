name: Terraform (apply)

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write
  pull-requests: write

concurrency:
  group: terraform-apply
  cancel-in-progress: false

jobs:
  apply:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: us-east-1

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Build scoring lambda bundle
        working-directory: infra/lambda/scoring
        run: npm ci --no-audit --no-fund && npm run build

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: infra/terraform/app
        run: terraform init

      - name: Terraform apply
        working-directory: infra/terraform/app
        run: |
          set -o pipefail
          terraform apply -auto-approve -no-color -input=false | tee apply.txt

      - name: Comment apply on PR
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const sha = context.sha;
            const { owner, repo } = context.repo;

            const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: sha,
            });

            if (!prs.data || prs.data.length === 0) {
              console.log(`No PR associated with commit ${sha}; skipping comment.`);
              return;
            }

            // Prefer the merged PR if there are multiple.
            const pr = prs.data.find(p => p.merged_at) || prs.data[0];

            const path = 'infra/terraform/app/apply.txt';
            const apply = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : 'No apply output found.';
            const trimmed = apply.length > 65000 ? apply.slice(0, 65000) + "\n\n... (truncated)" : apply;

            const body = `<!-- terraform-apply -->\n<details>\n<summary><strong>Terraform apply (infra/terraform/app)</strong></summary>\n\n\`\`\`\n${trimmed}\n\`\`\`\n</details>`;

            const issue_number = pr.number;
            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(c => (c.body || '').includes('<!-- terraform-apply -->'));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
