name: Terraform (plan)

on:
  pull_request:
    branches: [main]
    paths:
      - 'infra/terraform/app/**'
      - '.github/workflows/terraform-plan.yml'

permissions:
  contents: read
  id-token: write
  pull-requests: write

concurrency:
  group: terraform-plan-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  plan:
    runs-on: ubuntu-latest
    # Don't run with elevated AWS credentials on PRs from forks.
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_TERRAFORM_ROLE_ARN }}
          aws-region: us-east-1

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform init
        working-directory: infra/terraform/app
        run: terraform init

      - name: Terraform plan
        working-directory: infra/terraform/app
        run: |
          set -o pipefail
          terraform plan -no-color -input=false | tee plan.txt

      - name: Comment plan on PR
        if: ${{ always() }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = 'infra/terraform/app/plan.txt';
            const plan = fs.existsSync(path) ? fs.readFileSync(path, 'utf8') : 'No plan output found.';

            // GitHub comment body limit is ~65k characters.
            const trimmed = plan.length > 65000 ? plan.slice(0, 65000) + "\n\n... (truncated)" : plan;
            const body = `<!-- terraform-plan -->\n#### Terraform plan (infra/terraform/app)\n\n\`\`\`\n${trimmed}\n\`\`\``;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find(c => (c.body || '').includes('<!-- terraform-plan -->'));
            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
